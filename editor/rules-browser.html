<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CPQ Rules Editor</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1e1e1e; color: #d4d4d4; height: 100vh; display: flex; flex-direction: column; }
    .header { background: #252526; border-bottom: 1px solid #3c3c3c; padding: 8px 16px; display: flex; align-items: center; gap: 16px; flex-shrink: 0; }
    .header h1 { font-size: 1rem; font-weight: 400; color: #ccc; }
    .tabs { display: flex; gap: 0; flex-shrink: 0; background: #252526; border-bottom: 1px solid #3c3c3c; }
    .tab { padding: 8px 20px; cursor: pointer; font-size: 0.85rem; color: #969696; border-right: 1px solid #3c3c3c; user-select: none; display: flex; align-items: center; gap: 8px; }
    .tab:hover { color: #d4d4d4; }
    .tab.active { background: #1e1e1e; color: #fff; border-bottom: 2px solid #007acc; }
    .tab .dot { width: 8px; height: 8px; border-radius: 50%; display: none; }
    .tab.modified .dot { display: inline-block; background: #e8ab6a; }
    .main { flex: 1; display: flex; overflow: hidden; }
    .sidebar { width: 250px; background: #252526; border-right: 1px solid #3c3c3c; overflow-y: auto; flex-shrink: 0; }
    .sidebar h3 { padding: 12px 16px 8px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: #888; letter-spacing: 0.5px; }
    .node-list { list-style: none; }
    .node-item { padding: 6px 16px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .node-item:hover { background: #2a2d2e; }
    .node-item.active { background: #37373d; color: #fff; }
    .node-icon { font-size: 0.7rem; padding: 2px 6px; border-radius: 3px; font-weight: 600; }
    .node-icon.input { background: #2d7d46; color: #fff; }
    .node-icon.output { background: #9b2c2c; color: #fff; }
    .node-icon.function { background: #1a5276; color: #fff; }
    .node-icon.decision { background: #7d3c98; color: #fff; }
    .editor-area { flex: 1; display: flex; flex-direction: column; }
    .toolbar { background: #252526; padding: 6px 16px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #3c3c3c; flex-shrink: 0; }
    .btn { padding: 5px 14px; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8rem; font-family: inherit; }
    .btn-save { background: #0e639c; color: #fff; }
    .btn-save:hover { background: #1177bb; }
    .btn-save:disabled { opacity: 0.5; cursor: default; }
    .btn-test { background: #2d7d46; color: #fff; }
    .btn-test:hover { background: #388e4f; }
    .btn-secondary { background: #3c3c3c; color: #ccc; }
    .btn-secondary:hover { background: #4c4c4c; }
    .status { font-size: 0.8rem; color: #888; margin-left: auto; }
    .status.saved { color: #4ec9b0; }
    .status.error { color: #f48771; }
    #editor-container { flex: 1; }
    .panel-test { background: #1e1e1e; border-top: 1px solid #3c3c3c; max-height: 300px; overflow: auto; display: none; flex-shrink: 0; }
    .panel-test.visible { display: block; }
    .panel-header { padding: 8px 16px; background: #252526; font-size: 0.8rem; display: flex; align-items: center; justify-content: space-between; }
    .panel-body { padding: 12px 16px; }
    .panel-body pre { font-family: 'Cascadia Code', 'Fira Code', Consolas, monospace; font-size: 0.8rem; white-space: pre-wrap; color: #d4d4d4; }
    .loading { display: flex; align-items: center; justify-content: center; height: 100%; color: #888; font-size: 1rem; }
    .info-panel { padding: 16px; font-size: 0.85rem; line-height: 1.6; color: #aaa; }
    .info-panel strong { color: #d4d4d4; }
  </style>
</head>
<body>
  <div class="header">
    <h1>CPQ Rules Editor</h1>
  </div>

  <div class="tabs" id="file-tabs"></div>

  <div class="main">
    <div class="sidebar">
      <h3>Nodes</h3>
      <ul class="node-list" id="node-list"></ul>
    </div>
    <div class="editor-area">
      <div class="toolbar">
        <button class="btn btn-save" id="btn-save" disabled onclick="saveCurrentFile()">Opslaan (Ctrl+S)</button>
        <button class="btn btn-test" onclick="toggleTestPanel()">Test</button>
        <button class="btn btn-secondary" onclick="reloadCurrentFile()">Herladen</button>
        <span class="status" id="status"></span>
      </div>
      <div id="editor-container">
        <div class="loading">Selecteer een regelbestand...</div>
      </div>
      <div class="panel-test" id="test-panel">
        <div class="panel-header">
          <span>Test Resultaat</span>
          <button class="btn btn-secondary" onclick="toggleTestPanel()" style="padding:2px 8px;">Sluiten</button>
        </div>
        <div class="panel-body"><pre id="test-output">Voer een test uit...</pre></div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
  <script>
    const RULES_BASE = '/rules/default/families/roller-shutter';
    const AGENT_BASE = '/agent/api/projects/default/evaluate';
    const RULES = [
      { name: 'Validatie', file: 'validate.json', desc: 'Valideert configuratie-invoer' },
      { name: 'Opties', file: 'options.json', desc: 'Bepaalt beschikbare opties per parameter' },
      { name: 'Stuklijst', file: 'bom.json', desc: 'Genereert de stuklijst' },
    ];

    let editor = null;
    let currentFile = null;
    let files = {};
    let modified = {};

    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });

    require(['vs/editor/editor.main'], function () {
      monaco.editor.defineTheme('cpq-dark', {
        base: 'vs-dark',
        inherit: true,
        rules: [],
        colors: { 'editor.background': '#1e1e1e' }
      });
      renderTabs();
      loadFile(RULES[0].file);
    });

    function renderTabs() {
      const tabsEl = document.getElementById('file-tabs');
      tabsEl.innerHTML = RULES.map(r =>
        `<div class="tab${currentFile === r.file ? ' active' : ''}${modified[r.file] ? ' modified' : ''}"
              onclick="loadFile('${r.file}')" data-file="${r.file}">
          <span class="dot"></span>
          ${r.name}
        </div>`
      ).join('');
    }

    async function loadFile(filename) {
      currentFile = filename;
      renderTabs();
      setStatus('Laden...');

      try {
        const resp = await fetch(`${RULES_BASE}/${filename}`);
        const json = await resp.json();
        files[filename] = json;
        modified[filename] = false;

        renderNodeList(json);
        // Find the first function node
        const fnNode = json.nodes?.find(n => n.type === 'functionNode');
        if (fnNode) {
          showFunctionNode(fnNode);
        } else {
          showFullJson(json);
        }
        setStatus('Geladen', 'saved');
      } catch (e) {
        setStatus('Fout bij laden: ' + e.message, 'error');
      }
    }

    function renderNodeList(json) {
      const list = document.getElementById('node-list');
      if (!json.nodes) { list.innerHTML = '<li class="info-panel">Geen nodes gevonden</li>'; return; }
      list.innerHTML = json.nodes.map(n => {
        const type = n.type.replace('Node', '');
        const iconClass = type === 'input' ? 'input' : type === 'output' ? 'output' : type === 'function' ? 'function' : 'decision';
        return `<li class="node-item" onclick="selectNode('${n.id}')" data-id="${n.id}">
          <span class="node-icon ${iconClass}">${type.substring(0, 2).toUpperCase()}</span>
          ${n.name}
        </li>`;
      }).join('');
    }

    function selectNode(nodeId) {
      const json = files[currentFile];
      if (!json) return;
      const node = json.nodes.find(n => n.id === nodeId);
      if (!node) return;
      document.querySelectorAll('.node-item').forEach(el => el.classList.remove('active'));
      document.querySelector(`.node-item[data-id="${nodeId}"]`)?.classList.add('active');

      if (node.type === 'functionNode' && node.content?.source) {
        showFunctionNode(node);
      } else {
        showNodeJson(node);
      }
    }

    function showFunctionNode(node) {
      const source = node.content?.source || '';
      initEditor(source, 'javascript', (newSource) => {
        node.content.source = newSource;
        modified[currentFile] = true;
        renderTabs();
        document.getElementById('btn-save').disabled = false;
      });
      document.querySelectorAll('.node-item').forEach(el => el.classList.remove('active'));
      document.querySelector(`.node-item[data-id="${node.id}"]`)?.classList.add('active');
    }

    function showNodeJson(node) {
      const json = JSON.stringify(node, null, 2);
      initEditor(json, 'json', null);
    }

    function showFullJson(json) {
      const text = JSON.stringify(json, null, 2);
      initEditor(text, 'json', null);
    }

    function initEditor(content, language, onChange) {
      const container = document.getElementById('editor-container');
      if (editor) { editor.dispose(); }
      container.innerHTML = '';
      editor = monaco.editor.create(container, {
        value: content,
        language: language,
        theme: 'cpq-dark',
        minimap: { enabled: false },
        fontSize: 14,
        lineNumbers: 'on',
        scrollBeyondLastLine: false,
        wordWrap: 'on',
        automaticLayout: true,
        tabSize: 2,
        readOnly: !onChange,
      });
      if (onChange) {
        editor.onDidChangeModelContent(() => onChange(editor.getValue()));
        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, saveCurrentFile);
      }
    }

    async function saveCurrentFile() {
      if (!currentFile || !modified[currentFile]) return;
      const json = files[currentFile];
      setStatus('Opslaan...');
      try {
        const resp = await fetch(`${RULES_BASE}/${currentFile}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(json, null, 2)
        });
        if (resp.ok || resp.status === 204) {
          modified[currentFile] = false;
          renderTabs();
          document.getElementById('btn-save').disabled = true;
          setStatus('Opgeslagen! Regelengine herlaadt automatisch.', 'saved');
        } else {
          setStatus(`Opslaan mislukt: ${resp.status}`, 'error');
        }
      } catch (e) {
        setStatus('Fout: ' + e.message, 'error');
      }
    }

    function reloadCurrentFile() {
      if (currentFile) loadFile(currentFile);
    }

    function toggleTestPanel() {
      document.getElementById('test-panel').classList.toggle('visible');
    }

    function setStatus(msg, cls) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = 'status' + (cls ? ' ' + cls : '');
    }
  </script>
</body>
</html>
